<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BCM Monitor</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --danger: #ef4444;
      --success: #10b981;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Courier New', monospace;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container { max-width: 1000px; margin: 0 auto; padding: 1rem; }

    header {
      background: linear-gradient(135deg, #0b1020 0%, #111827 100%);
      border-bottom: 3px solid var(--accent);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      text-align: center;
    }

    h1 { margin: 0; font-size: 2rem; color: var(--accent); }
    .subtitle { color: var(--muted); margin: 0.5rem 0 0; font-size: 0.9rem; }

    .grid { 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .panel {
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s;
    }

    .panel:hover { box-shadow: 0 0 20px rgba(34, 211, 238, 0.3); }

    .panel-title {
      font-weight: 700;
      color: var(--accent);
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--accent);
    }

    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .sensor {
      background: #0b1020;
      border: 1px solid var(--muted);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .sensor-label {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .sensor-value {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 1s infinite;
    }

    .indicator.on {
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
    }

    .indicator.off {
      background: #374151;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-weight: 600;
    }

    .status-text.on { color: var(--success); }
    .status-text.off { color: var(--muted); }

    .logs-panel {
      background: var(--card);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 1.5rem;
      grid-column: 1 / -1;
    }

    .logs-title {
      font-weight: 700;
      color: var(--accent);
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--accent);
    }

    .logs-container {
      background: #0b1020;
      border: 1px solid var(--muted);
      border-radius: 8px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.85rem;
      line-height: 1.8;
      font-family: 'Courier New', monospace;
    }

    .log-entry {
      padding: 0.4rem 0;
      color: var(--text);
      word-break: break-word;
      border-bottom: 1px solid rgba(149, 165, 166, 0.1);
    }

    .log-entry:last-child { border-bottom: none; }

    .log-time {
      color: var(--muted);
      font-size: 0.8rem;
      margin-right: 0.5rem;
    }

    .footer {
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--muted);
    }

    @media (max-width: 600px) {
      .container { padding: 0.5rem; }
      h1 { font-size: 1.5rem; }
      .sensor-grid { grid-template-columns: 1fr; }
    }

    .connection-status {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--success);
      color: #001318;
    }

    .connection-status.offline {
      background: var(--danger);
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="connection-status" id="connStatus">üü¢ Online</div>

  <div class="container">
    <header>
      <h1>üöó BCM MONITOR</h1>
      <p class="subtitle">Sistema de Automa√ß√£o Automotiva</p>
    </header>

    <div class="grid">
      <!-- INPUTS -->
      <div class="panel">
        <div class="panel-title">üìç ENTRADAS (Sensores)</div>
        <div class="sensor-grid">
          <div class="sensor">
            <div class="sensor-label">Igni√ß√£o</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-ignicao"></span>
              <span class="status-text" id="txt-ignicao">OFF</span>
            </div>
          </div>
          <div class="sensor">
            <div class="sensor-label">Porta</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-porta"></span>
              <span class="status-text" id="txt-porta">OFF</span>
            </div>
          </div>
          <div class="sensor">
            <div class="sensor-label">Trava</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-trava"></span>
              <span class="status-text" id="txt-trava">OFF</span>
            </div>
          </div>
          <div class="sensor">
            <div class="sensor-label">Destrava</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-destrava"></span>
              <span class="status-text" id="txt-destrava">OFF</span>
            </div>
          </div>
        </div>
      </div>

      <!-- OUTPUTS -->
      <div class="panel">
        <div class="panel-title">üí° SA√çDAS (Luzes)</div>
        <div class="sensor-grid">
          <div class="sensor">
            <div class="sensor-label">Farol</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-farol"></span>
              <span class="status-text" id="txt-farol">OFF</span>
            </div>
          </div>
          <div class="sensor">
            <div class="sensor-label">DRL</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-drl"></span>
              <span class="status-text" id="txt-drl">OFF</span>
            </div>
          </div>
          <div class="sensor">
            <div class="sensor-label">Luz Teto</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-luz_teto"></span>
              <span class="status-text" id="txt-luz_teto">OFF</span>
            </div>
          </div>
          <div class="sensor">
            <div class="sensor-label">Luz P√©</div>
            <div class="sensor-value">
              <span class="indicator" id="ind-luz_pe"></span>
              <span class="status-text" id="txt-luz_pe">OFF</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- √öLTIMA A√á√ÉO E TIMERS -->
    <div class="logs-panel">
      <div class="logs-title">‚ö° √öltima A√ß√£o</div>
      <div class="logs-container" id="logs-container" style="min-height: 60px; display: flex; align-items: center;">
        <div class="log-entry" style="color: var(--muted); margin: 0;">Aguardando eventos...</div>
      </div>
    </div>

    <div class="logs-panel">
      <div class="logs-title">‚è±Ô∏è Timers Ativos</div>
      <div id="timers-container" style="background: #0b1020; border: 1px solid var(--muted); border-radius: 8px; padding: 1rem; font-size: 1.1rem; font-weight: 600; color: var(--accent); min-height: 80px; display: flex; flex-direction: column; gap: 0.5rem;">
        <div style="color: var(--muted);">Nenhum timer ativo</div>
      </div>
    </div>

    <div class="footer">
      Atualizado a cada 500ms | IP: 192.168.4.1 | Admin: admin / admin123
    </div>
  </div>

  <script>
    const inputs = ['ignicao', 'porta', 'trava', 'destrava'];
    const outputs = ['farol', 'drl', 'luz_teto', 'luz_pe'];
    let logs = [];
    let updateCount = 0;

    function updateStatus() {
      fetch('/api/status', {
        headers: {
          'Authorization': 'Basic ' + btoa('admin:admin123')
        }
      })
        .then(res => res.json())
        .then(data => {
          // Atualizar inputs
          inputs.forEach(inp => {
            const state = data[inp] || false;
            updateElement(inp, state, true);
          });

          // Atualizar outputs
          outputs.forEach(out => {
            const state = data[out] || false;
            updateElement(out, state, false);
          });

          updateConnStatus(true);
        })
        .catch(err => {
          console.error('Erro:', err);
          updateConnStatus(false);
        });

      // Atualizar logs e timers
      fetch('/api/logs', {
        headers: {
          'Authorization': 'Basic ' + btoa('admin:admin123')
        }
      })
        .then(res => res.json())
        .then(data => {
          // √öltima a√ß√£o
          const logsEl = document.getElementById('logs-container');
          if (data.ultimaacao && data.ultimaacao.length > 0) {
            logsEl.innerHTML = `<div class="log-entry" style="margin: 0; color: var(--accent);">${escapeHtml(data.ultimaacao)}</div>`;
          } else {
            logsEl.innerHTML = '<div class="log-entry" style="color: var(--muted); margin: 0;">Aguardando eventos...</div>';
          }

          // Timers
          const timersEl = document.getElementById('timers-container');
          const timers = data.timers || {};
          let timerHtml = '';

          if (timers.trava_ms !== undefined) {
            const remainingSecs = timers.trava_ms;
            timerHtml += `<div>üîí TRAVA: ${remainingSecs}s restante</div>`;
          }
          if (timers.destrava_ms !== undefined) {
            const remainingSecs = timers.destrava_ms;
            timerHtml += `<div>üîì DESTRAVA: ${remainingSecs}s restante</div>`;
          }

          if (timerHtml.length === 0) {
            timersEl.innerHTML = '<div style="color: var(--muted);">Nenhum timer ativo</div>';
          } else {
            timersEl.innerHTML = timerHtml;
          }
        })
        .catch(err => console.error('Erro logs:', err));
    }

    function updateElement(name, state, isInput) {
      const ind = document.getElementById(`ind-${name}`);
      const txt = document.getElementById(`txt-${name}`);

      if (ind && txt) {
        ind.classList.remove('on', 'off');
        ind.classList.add(state ? 'on' : 'off');

        txt.classList.remove('on', 'off');
        txt.classList.add(state ? 'on' : 'off');

        txt.textContent = state ? 'ON' : 'OFF';
      }
    }

    function updateConnStatus(online) {
      const el = document.getElementById('connStatus');
      if (online) {
        el.textContent = 'üü¢ Online';
        el.classList.remove('offline');
      } else {
        el.textContent = 'üî¥ Offline';
        el.classList.add('offline');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Atualizar a cada 500ms
    setInterval(updateStatus, 500);
    updateStatus(); // Primeira chamada
  </script>
</body>
</html>
